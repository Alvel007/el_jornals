# EL_JOURNALS - электронные журналы персонала подстанций

## Описание 

«EL_JOURNALS» — проект цифровизации документооботора для дежурного и административно - технического персонала электоподстанций. На данный момент реализована поддержка ведения в электронном виде оперативного журнала на объектах с постоянным дежурным персоналом. Имеется возможность внесения записей в хронологическом порядке, добавления к записям связанных файлов, а так же присвоения записям заданных атрибутов. 

♦ Стек применяемый технологий:

* Python
* Django
* PostgreSQL
* JavaScript
* Bootstrap
* jQuery
* Ajax
* HTML
* CSS
* Docker

Проект преднахначен для развертывания в локальной сети предприятия. Для оценки функционала «EL_JOURNALS» имеется открытая web-версия,доступная по адресу http://eljournals.zapto.org/  

Данные для входа администратора:   
    ```
    admin  
    ```
    ```
    admin
    ```  
Данные для входа тестового пользователя:  
    ```
    admin2
    ```
    ``` 
    147qw741
    ```

В проекте реализованы следующие роли пользователей:  
- Администратор  
- Дежурный персонал  
- Административно-технический персонал  
- Пользователь с расширенным доступом просмотра данных (осущесвляет контроль за качеством ведения документации).

В оперативном журнале автоматизированы многие действия, выполняемые дежурным персоналом, такие как:  
- Автоматическое присвоение времени создаваемой записи и подписи автора.  
- Автоматизация заполнения содержания записи заранее подготовлеными шаблонами (создаются адинистратором) и их последующая корректировка, в случае необходимости.  
- Для диспетчерского персонала центра управления сетями существует возможность редактирования шаблонов работ, выполняемых на воздушных линиях электропередач.  
- Автоматический учет выведенного оборудования из работы и проводимых на объекте работ, при выставлении соответствующих меток записям.  
- Цветовые метки для записей, позволяющие отслеживать и своевременно подавать заявки на продление работ, в случае такой необходимости.  
- Установка метки "недействительная запись" для имеющихся записей журнала.  

Административно - технический персонал имеет возможность просматривать записи журнала, отслеживать выведенное оборудование и проводимые работы на своем объекте, а также просматривать завершенные работы и переключения за установленный период времени. Кроме того, АТП имеет возможность оставлять комментарии к записям, сделанным дерурным персоналом объекта.  

Третья категория персонала имеет право просмотра оперативного журнала, как и АТП, но не имеет возможности вносить какие-либо записи/комментарии в журнал подстанции. Кроме того, третьей категории пользователей доступен просмотр некоторой служебной информации по созданным записям. таким как время создания комментария, фактическое время создания записей и т.д. Категория создана для возмодности ведения контроля и рекомендуется к назначению лицам из числа руководящего пероснала предприятия.

Существует возможность для каждого пользователя назначать отдельный список прав по каждому объекту, а так же их совмещение (например, лицам из числа АТП могут быть присвоены как оперативные права так и права административно-технического персонала на одном объекте).

Возможность регистрации пользователей доступна только из административной панели, так как каждый пользователь имеет строго ограниченный перечень прав и разрешений, который ему выдаются по результатам проверки знаний и индивидуальной программы подготовки по новой должности/присвоении оперативных прав.

## Установка

1. Клонируйте репозиторий на свой компьютер.

    ```bash
    git clone git@github.com:<ВАШ_USERNAME_GITHUB>/el_jornals.git
    ```
    ```bash
    cd el_jornals
    ```
2. Создайте файл .env в папке infra и заполните его своими данными. Перечень данных и их описание указаны в директории infra/.env.example.

### Создание Docker-образов

1.  Создаём образ для установки на сервер. Замените username на ваш логин на DockerHub:

    ```bash
    cd ..
    docker build -t <ВАШ_USERNAME_DOCKERHUB>/backend:latest backend/
    ```

2. Загрузите образ на DockerHub:

    ```bash
    docker push <ВАШ_USERNAME_DOCKERHUB>/backend
    ```

### Деплой на сервере

1. Настройте доступ к серверу по SSH-ключам. Создайте SSH-ключ на вашем ПК и дабавьте его в список доверенных на вашем сервере: 

    ```bash
    ssh-keygen -t rsa
    ssh-copy-id -i ~/.ssh/id_rsa.pub <username пользователя на сервере>@<ip или имя сервера>
    ```

2. Создайте на сервере директорию op_journals через терминал

    ```bash
    mkdir op_journals
    ```

3. В папку op_journals скопируйте папку static из проекта.


4. Установка docker compose на сервер:

    ```bash
    sudo apt update
    sudo apt install curl
    curl -fSL https://get.docker.com -o get-docker.sh
    sudo sh ./get-docker.sh
    sudo apt-get install docker-compose-plugin
    ```

5. В директорию пользователя  home/<ВАШ_USERNAME_НА_СЕРВЕРЕ>/op_journals/infra/ скопируйте файлы docker-compose.production.yml, nginx.conf и .env:

    ```bash
    scp -i path_to_SSH/SSH_name docker-compose.production.yml <ВАШ_USERNAME_НА_СЕРВЕРЕ>@<IP_СЕРВЕРА>:/home/<ВАШ_USERNAME_НА_СЕРВЕРЕ>/op_journals/infra/docker-compose.production.yml
    scp -i path_to_SSH/SSH_name nginx.conf <ВАШ_USERNAME_НА_СЕРВЕРЕ>@<IP_СЕРВЕРА>:/home/<ВАШ_USERNAME_НА_СЕРВЕРЕ>/op_journals/infra/nginx.conf
    * path_to_SSH — путь к файлу с SSH-ключом;
    * SSH_name — имя файла с SSH-ключом (без расширения);
    * username — ваше имя пользователя на сервере;
    * server_ip — IP вашего сервера.
    ```

6. Запустите docker compose в режиме демона:

    ```bash
    sudo docker compose -f docker-compose.production.yml up -d
    ```

7. Выполните миграции, соберите статические файлы бэкенда и скопируйте их в /static/:

    ```bash
    sudo docker compose -f docker-compose.production.yml exec backend python manage.py makemigrations
    sudo docker compose -f docker-compose.production.yml exec backend python manage.py migrate
    sudo docker compose -f docker-compose.production.yml exec backend python manage.py collectstatic --no-input
    sudo docker compose -f docker-compose.production.yml exec backend cp -r /app/collected_static/. /static/
    ```
    Создайте администратора:

    ```bash
    sudo docker compose -f docker-compose.production.yml exec backend python manage.py createsuperuser
    ```

8. На сервере в редакторе nano откройте конфиг Nginx:

    ```bash
    sudo nano /etc/nginx/sites-enabled/default
    ```

9. Измените настройки location в секции server:

    ```bash
    location / {
        proxy_pass http://127.0.0.1:8000;
    }
    ```

9. Проверьте работоспособность конфига Nginx:

    ```bash
    sudo nginx -t
    ```
    Если ответ в терминале такой, значит, ошибок нет:
    ```bash
    nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
    nginx: configuration file /etc/nginx/nginx.conf test is successful
    ```

10. Перезапускаем Nginx
    ```bash
    sudo systemctl reload nginx
    ```

11. Предоставьте nginx права доступа к файлам home/<ВАШ_USERNAME_НА_СЕРВЕРЕ>/op_journals/static/
    ```bash
    sudo chown nginx:nginx home/<ВАШ_USERNAME_НА_СЕРВЕРЕ>/op_journals/static/ -R
    ```


### Настройка CI/CD

1. Файл workflow уже написан. Он находится в директории

    ```bash
    el_jornals/.github/workflows/main.yml
    ```

2. Для адаптации его на своем сервере добавьте секреты в GitHub Actions:

    ```bash
    DOCKER_USERNAME                # имя пользователя в DockerHub
    DOCKER_PASSWORD                # пароль пользователя в DockerHub
    HOST                           # ip_address сервера
    USER                           # имя пользователя
    SSH_KEY                        # приватный ssh-ключ, созданный на сервере (cat ~/.ssh/id_rsa)
    SSH_PASSPHRASE                 # кодовая фраза (пароль) для ssh-ключа

    TELEGRAM_TO                    # id телеграм-аккаунта (можно узнать у @userinfobot, команда /start)
    TELEGRAM_TOKEN                 # токен бота (получить токен можно у @BotFather, /token, имя бота)
    ```

<br>

## Автор:
Кирилишин Алексей  
(alexkak@inbox.ru)
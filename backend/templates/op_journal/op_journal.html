{% load static %}
{% load widget_tweaks %}

<style>
  th:nth-child(1) {
    width: 13%;
  }
  th:nth-child(2) {
    width: 62%;
  }
  th:nth-child(3) {
    width: 20%;
  }
  #id_text {
    width: 100%;
    height: 12em;
    word-wrap: break-word;
  }
  #autocomplete-text {
    word-wrap: break-word;
  }
  .btn-group .btn {
    flex: 1;
    margin-right: 20px;
  }
  .mb-3 label,
  .mb-3 input[type="checkbox"] {
    display: inline-block;
    vertical-align: middle;
  }
  .clickable-cell {
    cursor: pointer;
  }

  #planned_completion_date_block {
  background-color: pink;
  border: 1px solid rgb(138, 138, 138);
  border-radius: 5px;
}
  .card.card-body {
  background-color: pink;
}

  .active {
    background-color: green; /* Цвет фона при активном состоянии */
    color: white; /* Цвет текста при активном состоянии */
}
</style>

<script type="text/javascript">
$(function() {
  var autocompleteUrl = $('#id_text').data('autocomplete-url'); // Получаем URL из данных поля

  $('#id_text').autocomplete({
    minLength: 3, // минимальное количество символов для начала поиска
    select: function(event, ui) {
      $('#id_text').val(ui.item.value);
      if (ui.item.out_of_work) {
        $('#important_event_checkbox').prop('checked', true);
        if (!ui.item.errors) {
          $('#planned_completion_date_block').show(); // Показываем блок
        }
      } else {
        $('#important_event_checkbox').prop('checked', false);
        if (!ui.item.errors) {
          $('#planned_completion_date_block').show(); // Показываем блок
        }
      }

      if (ui.item.enabling) {
        $('#collapseExample7').collapse('show');
      } else {
        $('#collapseExample7').collapse('hide');
      }

      if (ui.item.getting_started) {
        $('#collapseExample12').collapse('show');
      } else {
        $('#collapseExample12').collapse('hide');
      }

      return false;
    },
    search: function(event, ui) {
      if ($('#id_text').val().length < 3 || $('#id_text').val().length > 10) {
        return false; // прекращаем поиск, если количество символов не соответствует требованиям
      }
    },
    focus: function(event, ui) { // Добавлено: подсветка при наведении
      $(this).val(ui.item.value);
      return false;
    }
  }).data("ui-autocomplete")._renderItem = function(ul, item) {
    var listItem = $("<li>").text(item.label);
    if (item.out_of_work) {
      listItem.append(" (Out of work)");
    }
    return listItem.appendTo(ul);
  };

  $('#id_text').on('autocompleteselect', function(event, ui) {
  if (ui.item.out_of_work) {
    $('#permission_to_work_checkbox').prop('checked', true);
  } else {
    $('#permission_to_work_checkbox').prop('checked', false);
  }
  if ($('#permission_to_work_checkbox').is(':checked')) {
    if (ui.item.disabling) {
      $('#important_event_checkbox').prop('checked', true);
    } else {
      $('#important_event_checkbox').prop('checked', false);
    }
  } else {
    $('#important_event_checkbox').prop('checked', ui.item.disabling); // Изменено
    if (!ui.item.errors) {
      $('#planned_completion_date_block').toggle(ui.item.disabling); // Изменено
    }
  }
  if (ui.item.enabling) {
    $('#collapseExample7').collapse('show');
  } else {
    $('#collapseExample7').collapse('hide');
  }
  if (ui.item.getting_started) {
    $('#collapseExample12').collapse('show');
  } else {
    $('#collapseExample12').collapse('hide');
  }
});

  $('#id_text').keydown(function(e) {
    if (e.which == 13 && !e.shiftKey) {
      e.preventDefault();
      var cursorPosition = this.selectionStart;
      var textBefore = $(this).val().substring(0, cursorPosition);
      var textAfter = $(this).val().substring(cursorPosition);
      $(this).val(textBefore + "\n" + textAfter);
      this.selectionStart = this.selectionEnd = cursorPosition + 1;
    }
  });

  // Дополнительный код для скрытия блока при первой загрузке
  var plannedCompletionDateBlock = $('#planned_completion_date_block');
  plannedCompletionDateBlock.hide(); // Скрываем блок

  // Обработчик изменения состояния чекбокса
  $('#important_event_checkbox').on('change', function() {
    if (this.checked) {
      plannedCompletionDateBlock.show(); // Показываем блок
    } else {
      plannedCompletionDateBlock.hide(); // Скрываем блок
    }
  });

  // Добавляем проверку на состояние флажка important_event_checkbox при разворачивании collapseExample7
  $('#collapseExample7').on('show.bs.collapse', function () {
    if ($('#important_event_checkbox').is(':checked')) {
      return false; // Блокируем разворачивание
    }
  });
});
</script>

<script>
document.getElementById('id_text').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    this.value += '\n';
    e.preventDefault();
  }
});
</script>

<div class="d-flex justify-content-center">
  {% if user.is_authenticated %}
    {% with user.last_name as last_name %}
      {% with user.first_name|slice:"1" as first_initial %}
        {% with user.middle_name|slice:"1" as middle_initial %}
          {% with full_name=last_name|add:" "|add:first_initial|add:"."|add:middle_initial|add:"." %}
            {% with full_name|title as user_name %}
              <p class="navbar-text ml-2 text-danger h3">Вы авторизованы как {{ user.position }} 
                {% if user.main_place_work %} 
                  {{ user.main_place_work }}
                {% else %}
                  {{ user.substation_group.name_rp }}
                {% endif %}
                {{ user_name }}</p>
            {% endwith %}
          {% endwith %}
        {% endwith %}
      {% endwith %}
    {% endwith %}
  {% endif %}
</div>

<hr class="w-100">
<div class="card-body">
  <p class="d-flex justify-content-center btn-group mt-3">
    <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample2" aria-expanded="false" aria-controls="collapseExample">
      Поиск
    </button>
    <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample3" aria-expanded="false" aria-controls="collapseExample2">
      Выгрузить записи
    </button>
    <button class="btn btn-warning" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample4" aria-expanded="false" aria-controls="collapseExample3">
      Отклонения от исходной схемы
    </button>
    <button class="btn btn-warning" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample10" aria-expanded="false" aria-controls="collapseExample10">
      Работающие бригады
    </button>
    <button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample9" aria-expanded="false" aria-controls="collapseExample3">
      Введённое оборудование
    </button>
    <button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample11" aria-expanded="false" aria-controls="collapseExample3">
      Законченные работы
    </button>
  </p>
  <div class="collapse" id="collapseExample2">
    <div class="d-flex justify-content-center"><h2>Поиск по содержанию записей/по дате:</h2></div><br>
      <div class="d-flex justify-content-center">
        <form method="get" action="" class="search-form">
          <div class="d-flex flex-row align-items-center">
            <input type="text" name="query" placeholder="Поиск по тексту" class="w-50 mr-2">
            <div style="width: 10px;"></div>
            <input type="date" id="start_date" name="start_date" style="width: 180px;" class="mr-2">
            <div style="width: 10px;"></div>
            <input type="date" id="end_date" name="end_date" style="width: 180px;" class="mr-2">
            <div style="width: 10px;"></div>
            <button type="submit" class="btn btn-primary">Поиск</button>
            <div style="width: 25px;"></div>
            <button type="submit" name="reset" class="btn btn-primary ml-2">Сбросить</button>
          </div>
        </form>
      </div>
  </div>
  <div class="collapse" id="collapseExample3">
    <div class="d-flex justify-content-center"><h2>Выгрузить записи за период:</h2></div>
    <div class="d-flex justify-content-center">
      <form method="post" action="{% url 'export_records' substation_slug=substation_slug %}">
        {% csrf_token %}
        <input type="date" id="start_date_export" name="start_date" style="width: 180px;" class="mr-2" required>
        <input type="date" id="end_date_export" name="end_date" style="width: 180px;" class="mr-2" required>
        <button class="btn btn-primary" type="submit">Выгрузить в PDF</button>
      </form>
    </div>
  </div>
  <div class="collapse" id="collapseExample4">
    <div class="card card-bodys">
      <div class="d-flex justify-content-center"><h2>Текущие отклонения от исходной схемы</h2></div> 
      <div class="d-flex justify-content-center"><h2>{{ substation.name }}</h2></div>
      <ul>
        <hr class="w-100">
        <div class="table-responsive"style="width: 95%;">
          <table class="table table-bordered border-primary table-hover" style="width: 100%;">
            <thead>
              <tr>
                <th class="text-center" scope="col">Дата и время вывода оборудования в ремонт/отключения</th>
                <th class="text-center" scope="col">Содержание записи о выводе в ремонт оборудования/отключении</th>
                <th class="text-center" scope="col">Планируемая дата ввода оборудования в работу</th>
              </tr>
            </thead>
            <tbody>
              {% for repair in filtered_model_op_journal_data %}
                <tr>
                  <td class="clickable-cell text-wrap" onclick=window.location.href="{% url 'op_journal_edit' repair.pk %}">
                    {{ repair.pub_date }}
                  </td>
                  <td class="{% if repair.special_regime_introduced %}border border-danger border-5{% endif %}">
                    {{ repair.text }}<br>
                    {% if repair.files.all %}
                      Прикрепленные файлы:
                      {% for file in repair.files.all %}
                        <a href="{{ file.file.url }}" target="_blank">{{ file.file.name|cut:"OPJ/" }}</a>
                        {% if not forloop.last %}, {% endif %}
                      {% endfor %}
                      <br>
                    {% endif %}
                    {{ repair.user_signature }}
                  </td>
                  <td class="{% if repair.is_past_due %}bg-danger text-white{% elif repair.is_close_to_completion %}bg-warning text-white{% endif %}">
                    {{ repair.planned_completion_date }} 
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </ul>
      {% if substation.dispatch_point %}
        {% for substation_name, substation_records in records_by_substation.items %}  
          <div class="d-flex justify-content-center"><h2>{{ substation_name }}</h2></div>  
          {% if substation_records %}  
              <ul>  
                <div class="table-responsive"style="width: 95%;">
                      <table class="table table-bordered border-primary table-hover">  
                          <thead>  
                              <tr>  
                                  <th class="text-center" scope="col">Дата и время вывода оборудования в ремонт/отключения</th>  
                                  <th class="text-center" scope="col">Содержание записи о выводе в ремонт оборудования/отключении</th>  
                                  <th class="text-center" scope="col">Планируемая дата ввода оборудования в работу</th>
                              </tr>  
                          </thead>  
                          <tbody>  
                              {% for record in substation_records %}  
                                <tr>
                                  <td class="clickable-cell text-wrap" onclick=window.location.href="{% url 'op_journal_edit' record.pk %}">
                                          {{ record.pub_date }}</td>  
                                      <td class="{% if record.special_regime_introduced %}border border-danger border-5{% endif %}">  
                                          {{ record.text }}<br>
                                          {% if record.files.all %}
                                            Прикрепленные файлы:
                                            {% for file in record.files.all %}
                                              <a href="{{ file.file.url }}" target="_blank">{{ file.file.name|cut:"OPJ/" }}</a>
                                              {% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                            <br>
                                          {% endif %}
                                          {{ record.user_signature }}  
                                      </td>
                                      <td class="{% if record.is_past_due %}bg-danger text-white{% elif record.is_close_to_completion %}bg-warning text-white{% endif %}">
                                        {{ record.planned_completion_date }}
                                      </td>
                                  </tr>  
                              {% endfor %}  
                          </tbody>  
                      </table>  
                  </div>  
              </ul>  
        {% endif %}  
      {% endfor %}
      {% endif %}
    </div>
  </div>
  <div class="collapse" id="collapseExample9">
    <div class="d-flex justify-content-center"><h2>Введённое оборудование за последние {{ RETENTION_PERIOD_COMPLETED_RECORDS }} дней</h2></div>  
    <div class="d-flex justify-content-center"><h2>{{ substation.name }}</h2></div>  
    <ul>  
        <div class="table">  
            <table class="table table-bordered border-primary table-hover">  
                <thead>  
                  <tr>  
                      <th class="text-center" scope="col" style="width: 12%;">Дата и время записи вывода в ремонт/отключения</th>  
                      <th class="text-center" scope="col" style="width: 38%;">Содержание записи о выводе в ремонт/отключении</th> 
                      <th class="text-center" scope="col" style="width: 12%;">Дата и время записи ввода в работу оборудования</th>  
                      <th class="text-center" scope="col" style="width: 38%;">Содержание записи о вводе в работу оборудования</th>
                  </tr>
                </thead>  
                {% for disabling in disabling_model_op_journal_data %}  
                <tbody>  
                        <tr>  
                            <td>{{ disabling.pub_date }}</td>
                            <td>{{ disabling.text }}<br>
                                {% if disabling.files.all %}
                                Прикрепленные файлы:
                                  {% for file in disabling.files.all %}
                                    <a href="{{ file.file.url }}" target="_blank">{{ file.file.name|cut:"OPJ/" }}</a>
                                    {% if not forloop.last %}, {% endif %}
                                {% endfor %}<br>
                                {% endif %}
                                {{ disabling.user_signature }}</td>
                            <td>{% for entry in disabling.closing_entry.all %}
                                {{ entry.pub_date }}</td>
                            <td>{{ entry.text }}<br>
                                      {% if entry.files.all %}
                                    Прикрепленные файлы:
                                      {% for file in entry.files.all %}
                                        <a href="{{ file.file.url }}" target="_blank">{{ file.file.name|cut:"OPJ/" }}</a>
                                        {% if not forloop.last %}, {% endif %}
                                    {% endfor %}<br>
                                    {% endif %}
                                    {{ entry.user_signature }}
                                {% endfor %}</td>
                        </tr>
                </tbody> 
                {% endfor %} 
            </table>  
        </div>  
    </ul>

    {% if substation.dispatch_point %}
        {% for substation_name, completed_records in completed_records_by_substation.items %}
            <div class="d-flex justify-content-center"><h2>{{ substation_name }}</h2></div>
            {% if completed_records %}
                <ul>
                    <div class="table">
                        <table class="table table-bordered border-primary table-hover">
                            <thead>
                                <tr>
                                    <th class="text-center" scope="col" style="width: 12%;">Дата и время записи вывода в ремонт/допуска бригады</th>
                                    <th class="text-center" scope="col" style="width: 38%;">Содержание записи о выводе в ремонт/допуска бригады</th>
                                    <th class="text-center" scope="col" style="width: 12%;">Дата и время записи ввода в работу/окончания работ</th>
                                    <th class="text-center" scope="col" style="width: 38%;">Содержание записи о вводе в работу/окончании работ</th>
                                </tr>
                            </thead>
                            {% for disabling in completed_records %}
                                <tbody>
                                    <tr>
                                        <td>{{ disabling.pub_date }}</td>
                                        <td>{{ disabling.text }}<br>
                                            {% if disabling.files.all %}
                                                Прикрепленные файлы:
                                                {% for file in disabling.files.all %}
                                                    <a href="{{ file.file.url }}" target="_blank">{{ file.file.name|cut:"OPJ/" }}</a>
                                                    {% if not forloop.last %}, {% endif %}
                                                {% endfor %}<br>
                                            {% endif %}
                                            {{ disabling.user_signature }}
                                        </td>
                                        <td> {% for entry in disabling.closing_entry.all %}
                                          {{ entry.pub_date }}</td>
                                        <td>
                                                {{ entry.text }}<br>
                                                {% if entry.files.all %}
                                                    Прикрепленные файлы:
                                                    {% for file in entry.files.all %}
                                                        <a href="{{ file.file.url }}" target="_blank">{{ file.file.name|cut:"OPJ/" }}</a>
                                                        {% if not forloop.last %}, {% endif %}
                                                    {% endfor %}<br>
                                                {% endif %}
                                                {{ entry.user_signature }}
                                            {% endfor %}
                                        </td>
                                    </tr>
                                </tbody>
                            {% endfor %}
                        </table>
                    </div>
                </ul>
            {% endif %}
        {% endfor %}
    {% endif %}
  </div>

  <div class="collapse" id="collapseExample11">
    <div class="d-flex justify-content-center"><h2>Завершённые работы за последние {{ RETENTION_PERIOD_COMPLETED_RECORDS }} дней</h2></div>  
    <div class="d-flex justify-content-center"><h2>{{ substation.name }}</h2></div>  
    <ul>  
        <div class="table">  
            <table class="table table-bordered border-primary table-hover">  
                <thead>  
                  <tr>  
                      <th class="text-center" scope="col" style="width: 12%;">Дата и время записи о начале работ</th>  
                      <th class="text-center" scope="col" style="width: 38%;">Содержание записи о начале выполнения работ</th> 
                      <th class="text-center" scope="col" style="width: 12%;">Дата и время записи об окончании работ</th>  
                      <th class="text-center" scope="col" style="width: 38%;">Содержание записи об окончании работ</th>
                  </tr>
                </thead>  
                {% for disabling in worked_model_op_journal_data %}  
                <tbody>  
                        <tr>  
                            <td>{{ disabling.pub_date }}</td>
                            <td>{{ disabling.text }}<br>
                                {% if disabling.files.all %}
                                Прикрепленные файлы:
                                  {% for file in disabling.files.all %}
                                    <a href="{{ file.file.url }}" target="_blank">{{ file.file.name|cut:"OPJ/" }}</a>
                                    {% if not forloop.last %}, {% endif %}
                                {% endfor %}<br>
                                {% endif %}
                                {{ disabling.user_signature }}</td>
                            <td>{% for entry in disabling.closing_entry.all %}
                                {{ entry.pub_date }}</td>
                            <td>{{ entry.text }}<br>
                                      {% if entry.files.all %}
                                    Прикрепленные файлы:
                                      {% for file in entry.files.all %}
                                        <a href="{{ file.file.url }}" target="_blank">{{ file.file.name|cut:"OPJ/" }}</a>
                                        {% if not forloop.last %}, {% endif %}
                                    {% endfor %}<br>
                                    {% endif %}
                                    {{ entry.user_signature }}
                                {% endfor %}</td>
                        </tr>
                </tbody> 
                {% endfor %} 
            </table>  
        </div>  
    </ul>

    {% if substation.dispatch_point %}
        {% for substation_name, completed_records in compl_worked_records_by_substation.items %}
            <div class="d-flex justify-content-center"><h2>{{ substation_name }}</h2></div>
            {% if completed_records %}
                <ul>
                    <div class="table">
                        <table class="table table-bordered border-primary table-hover">
                            <thead>
                                <tr>
                                    <th class="text-center" scope="col" style="width: 12%;">Дата и время записи вывода в ремонт/допуска бригады</th>
                                    <th class="text-center" scope="col" style="width: 38%;">Содержание записи о выводе в ремонт/допуска бригады</th>
                                    <th class="text-center" scope="col" style="width: 12%;">Дата и время записи ввода в работу/окончания работ</th>
                                    <th class="text-center" scope="col" style="width: 38%;">Содержание записи о вводе в работу/окончании работ</th>
                                </tr>
                            </thead>
                            {% for disabling in completed_records %}
                                <tbody>
                                    <tr>
                                        <td>{{ disabling.pub_date }}</td>
                                        <td>{{ disabling.text }}<br>
                                            {% if disabling.files.all %}
                                                Прикрепленные файлы:
                                                {% for file in disabling.files.all %}
                                                    <a href="{{ file.file.url }}" target="_blank">{{ file.file.name|cut:"OPJ/" }}</a>
                                                    {% if not forloop.last %}, {% endif %}
                                                {% endfor %}<br>
                                            {% endif %}
                                            {{ disabling.user_signature }}
                                        </td>
                                        <td> {% for entry in disabling.closing_entry.all %}
                                          {{ entry.pub_date }}</td>
                                        <td>
                                                {{ entry.text }}<br>
                                                {% if entry.files.all %}
                                                    Прикрепленные файлы:
                                                    {% for file in entry.files.all %}
                                                        <a href="{{ file.file.url }}" target="_blank">{{ file.file.name|cut:"OPJ/" }}</a>
                                                        {% if not forloop.last %}, {% endif %}
                                                    {% endfor %}<br>
                                                {% endif %}
                                                {{ entry.user_signature }}
                                            {% endfor %}
                                        </td>
                                    </tr>
                                </tbody>
                            {% endfor %}
                        </table>
                    </div>
                </ul>
            {% endif %}
        {% endfor %}
    {% endif %}
  </div>
</div>


    <div class="collapse" id="collapseExample10">
      <div class="card card-bodys">
        <div class="d-flex justify-content-center">
          <h2>Текущие работы</h2>
        </div>
        <div class="d-flex justify-content-center">
          <h2>{{ substation.name }}</h2>
        </div>
        <ul>
          <hr class="w-100">
          <div class="table-responsive">
            <table class="table table-bordered border-primary table-hover">
              <thead>
                <tr>
                  <th class="text-center" scope="col">Дата и время начала<br>выполнения работ</th>
                  <th class="text-center" scope="col">Содержание записи о допуске персонала</th>
                </tr>
              </thead>
              <tbody>
                {% for repair in works_model_op_journal_data %}
                <tr>
                  <td>
                    {{ repair.pub_date }}
                  </td>
                  <td class="{% if repair.special_regime_introduced %}border border-danger border-5{% endif %}">
                    {{ repair.text }}<br>
                    {% if repair.files.all %}
                    Прикрепленные файлы:
                    {% for file in repair.files.all %}
                    <a href="{{ file.file.url }}" target="_blank">{{ file.file.name|cut:"OPJ/" }}</a>
                    {% if not forloop.last %}, {% endif %}
                    {% endfor %}
                    <br>
                    {% endif %}
                    {{ repair.user_signature }}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </ul>
        {% if substation.dispatch_point %}
        {% for substation_name, substation_records in work_by_substation.items %}  
          <div class="d-flex justify-content-center"><h2>{{ substation_name }}</h2></div>  
          {% if substation_records %}  
              <ul>  
                  <div class="table-responsive">  
                      <table class="table table-bordered border-primary table-hover">  
                          <thead>  
                              <tr>  
                                  <th class="text-center" scope="col">Дата и время начала<br>выполнения работ</th>  
                                  <th class="text-center" scope="col">Содержание записи о допуске персонала</th>  
                              </tr>  
                          </thead>  
                          <tbody>  
                              {% for record in substation_records %}  
                                  <tr>  
                                      <td>{{ record.pub_date }}</td>  
                                      <td class="{% if record.special_regime_introduced %}border border-danger border-5{% endif %}">  
                                          {{ record.text }}<br>
                                          {% if record.files.all %}
                                            Прикрепленные файлы:
                                            {% for file in record.files.all %}
                                              <a href="{{ file.file.url }}" target="_blank">{{ file.file.name|cut:"OPJ/" }}</a>
                                              {% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                            <br>
                                          {% endif %}
                                          {{ record.user_signature }}  
                                      </td>  
                                  </tr>  
                              {% endfor %}  
                          </tbody>  
                      </table>  
                  </div>  
              </ul>  
        {% endif %}  
      {% endfor %}
      {% endif %}
      </div>
    </div>
  </div>
</div>

{% if has_permission %}
<hr class="w-100">
<div style="width: 80%; margin: 0 auto;">
  


  <div class="btn-group-toggle" data-toggle="buttons">
    <p>
      <a class="btn btn-primary" style="width: 270px;" id="id_autocomplite"  data-bs-toggle="collapse" href="#collapseExample15" role="button" aria-expanded="false" aria-controls="collapseExample15">
        Доступные автозаписи
      </a>
    
    {% if substation.dispatch_point %}

      <a class="btn btn-primary" style="width: 270px;" id="id_substation"  data-bs-toggle="collapse" href="#collapseExample14" role="button" aria-expanded="false" aria-controls="collapseExample7">
        Диспетчерские автозаписи
      </a>
    </p>
    {% endif %}
  </div>
  <div class="collapse" id="collapseExample15">
    <table class="table table-bordered border-primary table-hover">
      <thead>
        <tr>
          <th class="text-center" scope="col">Все автоматические записи, доступные Вам.</th>
        </tr>
      </thead>
      <tbody>
        {% for auto_text in filter_autocomplite %}
          <tr>
            <td>
              {{ auto_text.text|linebreaksbr }}
            </td>
          
          {% endfor %}
          {% if substation.dispatch_point %}
            {% for disp_fill in disp_autofill %}
            <tr> 
              <td>
                {{disp_fill.hand_over_text|linebreaksbr}}
              </td>
            </tr>
            <tr> 
              <td>
                {{disp_fill.prm_tolerances|linebreaksbr}}
              </td>
            </tr>
            <tr> 
              <td>
                {{disp_fill.prm_only|linebreaksbr}}
              </td>
            </tr>
            <tr> 
              <td>
                {{disp_fill.admission_omly|linebreaksbr}}
              </td>
            </tr>
            <tr> 
              <td>
                {{disp_fill.without_tripping|linebreaksbr}}
              </td>
            </tr>
            <tr> 
              <td>
                {{disp_fill.at_substation|linebreaksbr}}
              </td>
            </tr>
            <tr> 
              <td>
                {{disp_fill.and_work|linebreaksbr}}
              </td>
            </tr>
            <tr> 
              <td>
                {{disp_fill.submit_vl|linebreaksbr}}
              </td>
            </tr>
            {% endfor %}
          {% endif %}

      </tbody>
    </table>
  </div>
  {% if substation.dispatch_point %}
  <div class="collapse" id="collapseExample14">
    <form method="POST" action="{% url 'autofill_form' substation_slug=substation_slug %}" class="form">
      {% csrf_token %}
      <div class="form-group">
        <label for="id_name">Укажите ВЛ:</label>
        <select id="id_name" name="name" class="form-control">
          <!-- Опции добавлены динамически с помощью JavaScript -->
        </select>
      </div>
      <div class="form-group">
        <label for="id_dispatcher">Укажите диспетчера:</label>
        <select id="id_dispatcher" name="dispatcher" class="form-control">
          <!-- Опции добавлены динамически с помощью JavaScript -->
        </select>
      </div>
      <div class="form-group">
        <label for="id_admitting">Укажите допускающего:</label>
        <select id="id_admitting" name="admitting" class="form-control">
          <!-- Опции добавлены динамически с помощью JavaScript -->
        </select>
      </div>
      <div class="form-group">
        <label for="id_ending">Укажите подстанцию:</label>
        <select id="id_ending" name="ending" class="form-control">
          <!-- Опции добавлены динамически с помощью JavaScript -->
        </select>
      </div>
      <div class="form-group">
        <label>Работы закончить до:</label>
        <p class="form-control-static">{{ autofill_form.end_time }}</p>
      </div>
      <div class="form-group">
        <label>Время аварийной готовности:</label>
        <p class="form-control-static">{{ autofill_form.emergency_entry }}</p>
      </div>
      <input type="hidden" name="cus_dispatcher" value="{{ substation.name }}">
      <button type="submit" class="btn btn-primary">Обновить автозаписи</button>
    </form>
  </div>
  {% endif %}

  <form method="POST" id="main_form_id" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="mb-3">
      <label id="autocomplete-text" for="id_text" class="form-label text-break">Содержание:</label>
      {{ form.text }}
      {% if form.text.errors %}
        <div class="text-danger">
          {% for error in form.text.errors %}
            <span>{{ error }}</span>
          {% endfor %}
        </div>
      {% endif %}
    </div>
    <div class="mb-3">
      <label for="id_pub_date" class="form-label">Время выполнения действия:</label>
      {{ form.pub_date }}
      {% if form.pub_date.errors %}
          <div class="text-danger">
              {% for error in form.pub_date.errors %}
                  <span>{{ error }}</span>
              {% endfor %}
          </div>
      {% endif %}
      <div class="error-message">
        {% if form.planned_completion_date.errors %}
        <ul class="errorlist" style="color: red;">
        {% for error in form.planned_completion_date.errors %}
            <span>{{ error }}</span>
          {% endfor %}
        </ul>  
        {% endif %}
      </div>
      {% if form.file.errors %}
          <ul class="errorlist" style="color: red;">
              {% for error in form.file.errors %}
                  <li>{{ error }}</li>
              {% endfor %}
          </ul>
      {% endif %}
    </div>
    <div class="row">
      <div class="btn-group-toggle" data-toggle="buttons">
        <p>
          <label class="btn btn-primary" style="width: 270px;">
            <input type="checkbox" id="important_event_checkbox" name="important_event_checkbox" {% if request.POST.important_event_checkbox %} checked {% endif %}>
            Вывод из работы/отключение
          </label>
          <label class="btn btn-primary" style="width: 270px;">
            <input type="checkbox" id="permission_to_work_checkbox" name="permission_to_work_checkbox">
            Допуск к выполнению работ
          </label>
        </p>
      </div>
    </div>
    <div class="mb-3" id="planned_completion_date_block" style="display: none;">
      <label for="id_planned_completion_date" class="form-label">
        <strong style="color: rgb(0, 0, 0);">Планируемые дата/время ввода оборудования в работу (из заявки):</strong>
      </label>
      {{form.planned_completion_date}}
    </div>
    <div class="row mt-2">
      <div class="btn-group-toggle" data-toggle="buttons">
        <p>
          <a class="btn btn-primary" style="width: 270px;" id="existing_entry"  data-bs-toggle="collapse" href="#collapseExample7" role="button" aria-expanded="false" aria-controls="collapseExample7"> 
            Ввод в работу оборудования 
          </a>
          <a class="btn btn-primary" style="width: 270px;" id="work_entry" data-bs-toggle="collapse" href="#collapseExample12" role="button" aria-expanded="false" aria-controls="collapseExample">
            Окончание работ
          </a>
          <a class="btn btn-primary" style="width: 270px;" data-bs-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
            Добавить особые параметры
          </a>
          <a class="btn btn-primary" style="width: 270px;" data-bs-toggle="collapse" href="#collapseExample6" role="button" aria-expanded="false" aria-controls="collapseExample">
            Загрузить доп. материалы
          </a>
        </p>
      </div>
    </div>
    <div class="collapse" id="collapseExample7"> 
      <div class="card card-body"> 
        <p>
          Выберите из выпадающего списка запись, <span style="color: red;">ВЫВОДА ОБОРУДОВАНИЯ ИЗ РАБОТЫ</span>, для исключения ее из отклонений.
        </p>
        {{form.existing_entry}} 
      </div>
    </div>
    <div class="collapse" id="collapseExample12"> 
      <div class="card card-body"> 
        <p>
          Выберите из выпадающего списка <span style="color: hsl(32, 100%, 50%);">РАБОТЫ, КОТОРЫЕ НУЖНО ЗАВЕРШИТЬ</span>, для исключения их из работающих бригад.
        </p>
        {{form.work_entry}} 
      </div> 
    </div>
    <div class="collapse" id="collapseExample">
      <div class="card card-bodys">
        <label for="id_special_regime_introduced" class="form-label">Введен особый режим работы:</label>
        {{ form.special_regime_introduced }}
        {% if form.special_regime_introduced.errors %}
          <div class="text-danger">
            {% for error in form.special_regime_introduced.errors %}
              <span>{{ error }}</span>
            {% endfor %}
          </div>
        {% endif %}
        <br>
        <label for="id_emergency_event" class="form-label">Случилось чрезвычайное событие: отключение, ЧП и т.д.:</label>
        {{ form.emergency_event }}
        {% if form.emergency_event.errors %}
          <div class="text-danger">
            {% for error in form.emergency_event.errors %}
              <span>{{ error }}</span>
            {% endfor %}
          </div>
        {% endif %}
        <br>
        <label for="id_short_circuit" class="form-label">Короткое замыкание в сети 6-35 кВ:</label>
        {{ form.short_circuit }}
        {% if form.short_circuit.errors %}
          <div class="text-danger">
            {% for error in form.short_circuit.errors %}
              <span>{{ error }}</span>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
    <div class="collapse" id="collapseExample6"> 
      <div class="card card-bodys"> 
        <div class="mb-3"> 
          <label for="id_file" class="form-label">Прикрепить файлы:</label> 
          {{ form.file }} 
          {% if form.file.errors %} 
            <div class="text-danger"> 
              {% for error in form.file.errors %} 
                <span>{{ error }}</span> 
              {% endfor %} 
            </div> 
          {% endif %} 
          <br> 
          Допускается загрузка от 1 до 5 файлов форматов jpg, jpeg, png и pdf. Размер каждого файла не должен превышать 5 МБ.<br> 
          Если вы хотите добавить несколько файлов, то все они должны располагаться в одной папке. Чтобы выбрать несколько файлов, нажмите CTRL и укажите файлы. 
        </div> 
      </div> 
    </div> 
    {{ form.substation|attr:"id:autocomplete-input" }} 
    <div class="d-grid gap-2"> 
      <button type="submit" id="save_gay" class="btn btn-primary" type="button">Добавить запись</button> 
    </div> 
    </form> 
    </div> 
    {% endif %}

<hr class="w-100">
<div class="d-flex justify-content-center"><h2>Внесённые записи в оперативный журнал {{substation.name}}</h2></div>  
<div class="table-responsive">
  <table class="table table-bordered border-primary table-hover">
    <thead>
      <tr>
        <th class="text-center" scope="col">Дата и время записи</th>
        <th class="text-center" scope="col">Содержание записей в течение смены, подписи о приёмке и сдаче смены</th>
        <th class="text-center" scope="col">Визы и замечания административно-технического персонала</th>
      </tr>
    </thead>
    <tbody>
      {% for post in model_op_journal_data %}
        <tr>
          <td class="clickable-cell {% if post.emergency_event and not post.short_circuit %}bg-danger text-white{% elif not post.emergency_event and post.short_circuit %}bg-primary text-white{% elif post.emergency_event and post.short_circuit %}bg-warning border border-primary text-white{% endif %} text-wrap" onclick=window.location.href="{% url 'op_journal_edit' post.pk %}">
            {{ post.pub_date }}
          </td>
          <td class="{% if post.special_regime_introduced %}border border-danger border-5{% endif %}">
            {% if post.entry_is_valid == False %}
            ОШИБОЧНАЯ ЗАПИСЬ!<br><s>{{ post.text|linebreaksbr }}<br>
            {% if post.files.all %}
              Прикрепленные файлы:
              {% for file in post.files.all %}
                <a href="{{ file.file.url }}" target="_blank">{{ file.file.name|cut:"OPJ/" }}</a>
                {% if not forloop.last %}, {% endif %}
              {% endfor %}
              <br>
            {% endif %}
            {{ post.user_signature }}</s>
            {% else %}
            {{ post.text|linebreaksbr }}<br>
            {% if post.files.all %}
              Прикрепленные файлы:
              {% for file in post.files.all %}
                <a href="{{ file.file.url }}" target="_blank">{{ file.file.name|cut:"OPJ/" }}</a>
                {% if not forloop.last %}, {% endif %}
              {% endfor %}
              <br>
            {% endif %}
            {{ post.user_signature }}
            {% endif %}
          </td>
          <td>
            {% if post.comment %}
              <div style="word-wrap: break-word;">
                {{ post.comment.text }}<br>{{ post.comment.user_signature }}
              </div>
            {% else %}
              <form id="comment-form-{{ post.pk }}" for="id_texs" method="post" action="{% url 'add_comment' post.pk %}">
                {% csrf_token %}
                {{ comment_form.text }}
                <button type="submit" style="display: none;">Добавить комментарий</button>
              </form>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="row justify-content-md-center">
  {% if is_paginated %}
  <div class="col-2 my-auto text-center-md">
    <nav aria-label="...">
      <ul class="pagination">
        {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Предыдущая</a></li>
        {% endif %}
        <li class="page-item {% if page_obj.number == page_obj.paginator.num_pages %}active{% endif %}"><a class="page-link" style="width: 100px;">Стр. {{ page_obj.number }}</a></li>
        {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Следующая</a></li>
        {% endif %}
      </ul>
    </nav>
    <div class="pagination-form mt-2">
      <form action="" method="get">
        <input type="number" name="page" min="1" max="{{ page_obj.paginator.num_pages }}" placeholder="Страница">
        <input class="btn btn-primary" type="submit" value="Перейти">
      </form>
    </div>
  </div>
  {% endif %}
</div>
<input type="hidden" id="serialized_data" value='{{ data_vl | safe }}'>
<script>
// Вытаскивает из json на странице данные и вставляем в форму автозаписи
document.addEventListener('DOMContentLoaded', function() {
  var serializedDataElement = document.getElementById('serialized_data');
  if (serializedDataElement) {
    var serializedData = JSON.parse(serializedDataElement.value);
    var nameSelect = document.getElementById('id_name');
    var dispatcherSelect = document.getElementById('id_dispatcher');
    var admittingSelect = document.getElementById('id_admitting');
    var endingSelect = document.getElementById('id_ending');  // Добавили endingSelect

    serializedData.forEach(function(item) {
      var name = item.name;
      var option = document.createElement('option');
      option.text = name;
      option.value = name;
      nameSelect.add(option);
    });

    updateSelectOptions(nameSelect.value, dispatcherSelect, 'dispatchers');
    updateSelectOptions(nameSelect.value, admittingSelect, 'admitting');
    updateSelectOptions(nameSelect.value, endingSelect, 'endings');

    nameSelect.addEventListener('change', function() {
      updateSelectOptions(nameSelect.value, dispatcherSelect, 'dispatchers');
      updateSelectOptions(nameSelect.value, admittingSelect, 'admitting');
      updateSelectOptions(nameSelect.value, endingSelect, 'endings');
    });

    function updateSelectOptions(selectedValue, selectElement, property) {
      selectElement.innerHTML = '';
      var selectedData = serializedData.find(function(item) {
        return item.name === selectedValue;
      });
      if (selectedData) {
        selectedData[property].forEach(function(item) {
          var option = document.createElement('option');
          option.text = item;
          option.value = item;
          selectElement.add(option);
        });
      }
    }
  }
});

// Вставляем даты в поиск и выгрузку из журнала
document.addEventListener('DOMContentLoaded', function() {
  var today = new Date().toISOString().split('T')[0];
  document.getElementById('start_date').value = today;
  document.getElementById('end_date').value = today;
  document.getElementById('start_date_export').value = today;
  document.getElementById('end_date_export').value = today;
});

// Не позволяем при поиске указать дату окончания раньше, чем дату начала поиска
document.addEventListener('DOMContentLoaded', function() {
  var startDateInput = document.getElementById('start_date');
  var endDateInput = document.getElementById('end_date');

  endDateInput.addEventListener('input', function() {
    if (endDateInput.value < startDateInput.value) {
      endDateInput.setCustomValidity('Дата окончания поиска должна быть больше или равна дате начала поиска');
    } else {
      endDateInput.setCustomValidity('');
    }
  });
});

// Кнопка сброса поиска возвращает на страницу объекта
document.addEventListener('DOMContentLoaded', function() {
  var resetButton = document.querySelector('button[name="reset"]');
  resetButton.addEventListener('click', function(event) {
    event.preventDefault();
    var currentUrl = window.location.href;
    window.location.href = currentUrl.split('?')[0];
  });
});

// Проверка последовательности дат при выгрузке файла
document.addEventListener('DOMContentLoaded', function() {
  var startDateExportInput = document.getElementById('start_date_export');
  var endDateExportInput = document.getElementById('end_date_export');

  endDateExportInput.addEventListener('input', function() {
    if (endDateExportInput.value < startDateExportInput.value) {
      endDateExportInput.setCustomValidity('Конечная дата выгрузки должна быть больше или равна начальной дате');
    } else {
      endDateExportInput.setCustomValidity('');
    }
  });
});

// Проверка времени ввода оборудования в работу, если соответствующий чекбокс включен
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('main_form_id');
  const plannedCompletionDateInput = document.getElementById('id_planned_completion_date');
  const textField = document.getElementById('id_text'); // Получаем текстовое поле
  
  form.addEventListener('submit', function(event) {
    const importantEventCheckbox = document.getElementById('important_event_checkbox');
    const pubDateValue = new Date(document.getElementById('id_pub_date').value);
    const plannedCompletionDateValue = new Date(plannedCompletionDateInput.value);
    
    if (importantEventCheckbox.checked) {
      if (pubDateValue > plannedCompletionDateValue) {
        const errorMessage = 'Дата завершения не может быть раньше даты начала!';
        plannedCompletionDateInput.setCustomValidity(errorMessage);
      } else {
        plannedCompletionDateInput.setCustomValidity('');
      }
      
      if (!form.checkValidity()) {
        event.preventDefault();
      }
    }
  });
  
  plannedCompletionDateInput.addEventListener('input', function() {
    this.setCustomValidity(''); // Очищаем сообщение об ошибке при изменении значения
  });
  
  textField.addEventListener('change', function() {
    const inputValue = textField.value;
    const errorMessage = 'Проверьте содержание записи!!!';
    
    if (inputValue.includes('***')) {
      textField.setCustomValidity(errorMessage);
    } else {
      textField.setCustomValidity('');
    }
  });
});

document.addEventListener("DOMContentLoaded", function() {
    var toggleButton = document.getElementById("special-params-toggle");
    var specialParamsDiv = document.getElementById("special-params");
    toggleButton.addEventListener("click", function() {
      if (specialParamsDiv.style.display === "none") {
        specialParamsDiv.style.display = "block";
      } else {
        specialParamsDiv.style.display = "none";
      }
    });
  });

  document.addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
      event.preventDefault();
      let formId = event.target.closest("td").querySelector("form").id;
      document.getElementById(formId).submit();
    }
  });

  var currentDate = new Date().toISOString().split('T')[0];

  document.addEventListener("DOMContentLoaded", function() {
    var cells = document.querySelectorAll(".clickable-cell");
    cells.forEach(function(cell) {
      cell.addEventListener("click", function() {
        var href = this.getAttribute("data-href");
        if (href) {
          window.location.href = href;
        }
      });
    });
  });
</script>
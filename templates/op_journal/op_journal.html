{% load static %}
{% load widget_tweaks %}
<style>
  th:nth-child(1) {
    width: 13%;
  }
  th:nth-child(2) {
    width: 62%;
  }
  th:nth-child(3) {
    width: 20%;
  }
  #id_text {
    width: 100%;
    height: 4em;
    word-wrap: break-word;
  }
  #autocomplete-text {
    word-wrap: break-word;
  }

  .btn-group .btn {
    flex: 1;
    margin-right: 20px;
  }
  .mb-3 label,
  .mb-3 input[type="checkbox"] {
    display: inline-block;
    vertical-align: middle;
  }
</style>

<script type="text/javascript">
  console.log(autocompleteUrl);
  $(function() {
      var autocompleteUrl = $('#id_text').data('data-autocomplete-url'); // Получаем URL из данных поля

      $('#id_text').autocomplete({
          source: function(request, response) {
              $.ajax({
                  url: autocompleteUrl,
                  data: {
                      term: request.term
                  },
                  dataType: 'json',
                  success: function(data) {
                      response(data);
                  }
              });
          },
          minLength: 2,  // Минимальная длина строки для начала поиска
          select: function(event, ui) {
              $('#id_text').val(ui.item.value);
              return false;
          }
      });
  });
</script>

<hr class="w-100">
<div class="d-flex justify-content-center">
  <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample5" aria-expanded="false" aria-controls="collapseExample">
    Сервис
  </button>
</div>
<div class="collapse" id="collapseExample5">
  <div class="card-body">
    <p class="d-flex justify-content-center btn-group mt-3">
      <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample2" aria-expanded="false" aria-controls="collapseExample">
        Поиск
      </button>
      <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample3" aria-expanded="false" aria-controls="collapseExample2">
        Выгрузить записи
      </button>
      <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample4" aria-expanded="false" aria-controls="collapseExample3">
        Пока пусто
      </button>
    </p>
    <div class="collapse" id="collapseExample2">
      <div class="card card-body">
        <div class="d-flex justify-content-center">
          <form method="get" action="" class="search-form">
            <div class="d-flex flex-row align-items-center">
              <input type="text" name="query" placeholder="Поиск по тексту" class="w-50 mr-2">
              <div style="width: 10px;"></div>
              <input type="date" name="start_date" style="width: 180px;" class="mr-2">
              <div style="width: 10px;"></div>
              <input type="date" name="end_date" style="width: 180px;" class="mr-2">
              <div style="width: 10px;"></div>
              <button type="submit" class="btn btn-primary">Поиск</button>
              <div style="width: 25px;"></div>
              <button type="submit" name="reset" class="btn btn-primary ml-2">Сбросить</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="collapse" id="collapseExample3">
      <div class="d-flex justify-content-center">
        <form method="post" action="{% url 'export_records' substation_slug=substation_slug %}">
          {% csrf_token %}
          <input type="date" name="start_date" style="width: 180px;" class="mr-2" required>
          <input type="date" name="end_date" style="width: 180px;" class="mr-2" required>
          <button class="btn btn-primary" type="submit">Выгрузить в PDF</button>
        </form>
      </div>
    </div>
    <div class="collapse" id="collapseExample4">
      <div class="card card-body">
        Третье содержимое для третьей кнопки.
      </div>
    </div>
  </div>
</div>
<hr class="w-100">

<div style="width: 80%; margin: 0 auto;">
  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="mb-3">
      <label id="autocomplete-text" for="id_text" class="form-label text-break">Содержание:</label>
      {{ form.text }}
      {% if form.text.errors %}
        <div class="text-danger">
          {% for error in form.text.errors %}
            <span>{{ error }}</span>
          {% endfor %}
        </div>
      {% endif %}
    </div>
    <div class="mb-3">
        <label for="id_pub_date" class="form-label">Время выполнения действия:</label>
        {{ form.pub_date }}
        {% if form.pub_date.errors %}
        <div class="text-danger">
            {% for error in form.pub_date.errors %}
            <span>{{ error }}</span>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    <p>
    <a class="btn btn-primary" data-bs-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
      Добавить особые параметры
    </a>
    </p>
    <div class="collapse" id="collapseExample">
      <div class="card card-body">
        <label for="id_special_regime_introduced" class="form-label">Введен особый режим работы:</label>
        {{ form.special_regime_introduced }}
        {% if form.special_regime_introduced.errors %}
          <div class="text-danger">
            {% for error in form.special_regime_introduced.errors %}
              <span>{{ error }}</span>
            {% endfor %}
          </div>
        {% endif %}
        <br>
        <label for="id_emergency_event" class="form-label">Случилось чрезвычайное событие: отключение, ЧП и т.д.:</label>
        {{ form.emergency_event }}
        {% if form.emergency_event.errors %}
          <div class="text-danger">
            {% for error in form.emergency_event.errors %}
              <span>{{ error }}</span>
            {% endfor %}
          </div>
        {% endif %}
        <br>
        <label for="id_short_circuit" class="form-label">Короткое замыкание в сети 6-35 кВ:</label>
        {{ form.short_circuit }}
        {% if form.short_circuit.errors %}
          <div class="text-danger">
            {% for error in form.short_circuit.errors %}
              <span>{{ error }}</span>
            {% endfor %}
          </div>
        {% endif %}
        <br>
        <label for="id_file" class="form-label">Добавить файлы</label>
        {{ form.file }}
        {% if form.file.errors %}
          <div class="text-danger">
            {% for error in form.file.errors %}
              <span>{{ error }}</span>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
    {{ form.substation|attr:"id:autocomplete-input" }}
    <div class="d-grid gap-2">
    <button type="submit" class="btn btn-primary" type="button">Добавить запись</button>
    </div>
  </form>
</div>
<hr class="w-100">

<div class="table-responsive">
  <table class="table table-bordered border-primary table-hover">
    <thead>
      <tr>
        <th class="text-center" scope="col">Дата и время записи</th>
        <th class="text-center" scope="col">Содержание записей в течение смены, подписи о приёмке и сдаче смены</th>
        <th class="text-center" scope="col">Визы и замечания административно-технического персонала</th>
      </tr>
    </thead>
    <tbody>
      {% for post in model_op_journal_data %}
      <tr>
        <td class="{% if post.emergency_event and not post.short_circuit %}bg-danger text-white{% elif not post.emergency_event and post.short_circuit %}bg-primary text-white{% elif post.emergency_event and post.short_circuit %}bg-warning border border-primary text-white{% endif %} text-wrap">{{ post.pub_date }}</td>
        <td class="clickable-cell {% if post.special_regime_introduced %}border border-danger border-5{% endif %}" data-href="{% url 'op_journal_edit' post.pk %}">
          {% if post.entry_is_valid == False %}
          ОШИБОЧНАЯ ЗАПИСЬ!<br><strike>{{ post.text }}<br>{{ post.user.position }} {{ post.user }}</strike>
          {% else %}
          {{ post.text }}<br>{{ post.user.position }} {{ post.user }}
          {% endif %}
        </td>
        <td>
          {% if post.comment %}
            <div style="word-wrap: break-word;">
              {{ post.comment.text }}<br>{{ post.comment.user.position }} {{ post.comment.user }}
            </div>
          {% else %}
            <form id="comment-form-{{ post.pk }}" method="post" action="{% url 'add_comment' post.pk %}">
              {% csrf_token %}
              {{ comment_form.text }}
              <button type="submit" style="display: none;">Добавить комментарий</button>
            </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="row justify-content-md-center">
  {% if is_paginated %}
  <div class="col-2 my-auto text-center-md">
    <nav aria-label="...">
      <ul class="pagination">
        {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Предыдущая</a></li>
        {% endif %}
        <li class="page-item {% if page_obj.number == page_obj.paginator.num_pages %}active{% endif %}"><a class="page-link" style="width: 100px;">Стр. {{ page_obj.number }}</a></li>
        {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Следующая</a></li>
        {% endif %}
      </ul>
    </nav>
    <div class="pagination-form mt-2">
      <form action="" method="get">
        <input type="number" name="page" min="1" max="{{ page_obj.paginator.num_pages }}" placeholder="Страница">
        <input class="btn btn-primary" type="submit" value="Перейти">
      </form>
    </div>
  </div>
  {% endif %}
</div>

<script>
  document.addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
      event.preventDefault();
      let formId = event.target.closest("td").querySelector("form").id;
      document.getElementById(formId).submit();
    }
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    var toggleButton = document.getElementById("special-params-toggle");
    var specialParamsDiv = document.getElementById("special-params");

    toggleButton.addEventListener("click", function() {
      if (specialParamsDiv.style.display === "none") {
        specialParamsDiv.style.display = "block";
      } else {
        specialParamsDiv.style.display = "none";
      }
    });
  });

  document.addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
      event.preventDefault();
      let formId = event.target.closest("td").querySelector("form").id;
      document.getElementById(formId).submit();
    }
  });

  var currentDate = new Date().toISOString().split('T')[0];
  
  document.addEventListener("DOMContentLoaded", function() {
    var cells = document.querySelectorAll(".clickable-cell");
    cells.forEach(function(cell) {
      cell.addEventListener("click", function() {
        var href = this.getAttribute("data-href");
        if (href) {
          window.location.href = href;
        }
      });
    });
  });
</script>
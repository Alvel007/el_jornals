{% load static %}
{% load widget_tweaks %}
<style>
  th:nth-child(1) {
    width: 13%;
  }
  th:nth-child(2) {
    width: 62%;
  }
  th:nth-child(3) {
    width: 20%;
  }
  #id_text {
    width: 100%;
    height: 4em;
    word-wrap: break-word;
  }
  #autocomplete-text {
    word-wrap: break-word;
  }
</style>

<script type="text/javascript">
  console.log(autocompleteUrl);
  $(function() {
      var autocompleteUrl = $('#id_text').data('data-autocomplete-url'); // Получаем URL из данных поля

      $('#id_text').autocomplete({
          source: function(request, response) {
              $.ajax({
                  url: autocompleteUrl,
                  data: {
                      term: request.term
                  },
                  dataType: 'json',
                  success: function(data) {
                      response(data);
                  }
              });
          },
          minLength: 2,  // Минимальная длина строки для начала поиска
          select: function(event, ui) {
              $('#id_text').val(ui.item.value);
              return false;
          }
      });
  });
</script>

<div style="width: 80%; margin: 0 auto;">
  <form method="POST">
    {% csrf_token %}
    <div class="mb-3">
      <label id="autocomplete-text" for="id_text" class="form-label text-break">Содержание:</label>
      {{ form.text }}
      {% if form.text.errors %}
        <div class="text-danger">
          {% for error in form.text.errors %}
            <span>{{ error }}</span>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <div class="mb-3">
        <label for="id_pub_date" class="form-label">Время выполнения действия:</label>
        {{ form.pub_date }}
        {% if form.pub_date.errors %}
        <div class="text-danger">
            {% for error in form.pub_date.errors %}
            <span>{{ error }}</span>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    <div class="mb-3">
      <label for="id_special_regime_introduced" class="form-label">Ввод особого режима работы, Да/Нет:</label>
      {{ form.special_regime_introduced }}
      {% if form.special_regime_introduced.errors %}
        <div class="text-danger">
          {% for error in form.special_regime_introduced.errors %}
            <span>{{ error }}</span>
          {% endfor %}
        </div>
      {% endif %}
    </div>
    <div class="mb-3">
      <label for="id_emergency_event" class="form-label">Чрезвычайное событие, Да/Нет:</label>
      {{ form.emergency_event }}
      {% if form.emergency_event.errors %}
        <div class="text-danger">
          {% for error in form.emergency_event.errors %}
            <span>{{ error }}</span>
          {% endfor %}
        </div>
      {% endif %}
    </div>
    <div class="mb-3">
      <label for="id_short_circuit" class="form-label">КЗ в сети 6-35 кВ, Да/Нет:</label>
      {{ form.short_circuit }}
      {% if form.short_circuit.errors %}
        <div class="text-danger">
          {% for error in form.short_circuit.errors %}
            <span>{{ error }}</span>
          {% endfor %}
        </div>
      {% endif %}
    </div>
    {{ form.substation|attr:"id:autocomplete-input" }}
    <button type="submit" class="btn btn-primary">Добавить запись</button>
  </form>
</div>


<div class="table-responsive">
  <table class="table table-bordered border-primary table-hover">
    <thead>
      <tr>
        <th class="text-center" scope="col">Дата и время записи</th>
        <th class="text-center" scope="col">Содержание записей в течение смены, подписи о приёмке и сдаче смены</th>
        <th class="text-center" scope="col">Визы и замечания административно-технического персонала</th>
      </tr>
    </thead>
      <tbody>
        {% for post in model_op_journal_data %}
        <tr>
          <td class="{% if post.emergency_event and not post.short_circuit %}bg-danger text-white{% elif not post.emergency_event and post.short_circuit %}bg-primary text-white{% elif post.emergency_event and post.short_circuit %}bg-danger border border-primary border-5 text-white{% endif %} text-wrap">{{ post.pub_date }}</td>
          <td class="clickable-cell {% if post.special_regime_introduced %} border border-danger border-5 {% endif %}" data-href="{% url 'op_journal_edit' post.pk %}">
            {% if post.entry_is_valid == False %}
            ОШИБОЧНАЯ ЗАПИСЬ!<br><strike>{{ post.text }}<br>{{ post.user.position }} {{ post.user }}</strike>

            {% else %}
            {{ post.text }}<br>{{ post.user.position }} {{ post.user }}
            {% endif %}
          </td>
          <td>{{ post.comment }}</td>
        </tr>
        {% endfor %}
      </tbody>
  </table>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    var cells = document.querySelectorAll(".clickable-cell");
    cells.forEach(function(cell) {
      cell.addEventListener("click", function() {
        var href = this.getAttribute("data-href");
        if (href) {
          window.location.href = href;
        }
      });
    });
  });
</script>
<div class="row justify-content-md-center">
  {% if model_op_journal_data.paginator.num_pages > 1 %}
  <div class="col-2 my-auto text-center-md">
    <nav aria-label="...">
      <ul class="pagination">
        {% if model_op_journal_data.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ model_op_journal_data.previous_page_number }}">Предыдущая</a></li>
        {% endif %}
        <li class="page-item"><a class="page-link">Стр. {{ model_op_journal_data.number }}</a></li>
        {% if model_op_journal_data.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ model_op_journal_data.next_page_number }}">Следующая</a></li>
        {% endif %}
      </ul>
    </nav>
    <li class="page-item">
      <form action="" method="get">
        <input type="number" name="page" min="1" max="{{ model_op_journal_data.paginator.num_pages }}" placeholder="Страница">
        <input type="submit" value="Перейти">
      </form>
    </li>
  </div>
  {% endif %}
</div>